<script>
// Filter submissions table by selected student (matric number)
document.addEventListener('DOMContentLoaded', function() {
  var select = document.getElementById('student-select');
  var table = document.querySelector('.table-container table.supervisor-table');
  if (select && table) {
    select.addEventListener('change', function() {
      var value = this.value;
      var rows = table.querySelectorAll('tbody tr');
      rows.forEach(function(row) {
        var matricCell = row.querySelector('td');
        if (!value || (matricCell && matricCell.textContent.trim().startsWith(value))) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    });
  }
});
</script>
{% extends 'SIWES/base.html' %}
{% load static %}
{% load tz %}
{% block content %}
<link rel="stylesheet" href="{% static 'supervisor_dashboard.css' %}">
<div class="login-page">
  <div class="login-form">
  <h1>Welcome, <span style="color: rgb(58, 56, 56); font-family: 'Orbitron', sans-serif;"> {% if user.title %}{{ user.title }} {% endif %}{{ user.get_full_name|default:user.email }}</span></h1>
  <h3 style="color:#2563eb; margin-bottom:1.5rem;">You have {{ students|length }} assigned student{{ students|length|pluralize }}.</h3>
    <div class="list-students" style="background: #e0e7ff; border-left: 6px solid #2563eb; border-radius: 8px; padding: 1.5rem 2rem; margin-bottom: 2rem; box-shadow: 0 2px 8px rgba(30,41,59,0.06);">
      <div style="display: flex; align-items: center; margin-bottom: 1rem;">
        <svg style="margin-right: 0.7rem; color: #2563eb; min-width: 28px;" xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05C15.64 13.36 17 14.28 17 15.5V19h7v-2.5c0-2.22-4.78-3.5-7-3.5z"/></svg>
        <h3 style="color: #2563eb; font-size: 1.25rem; font-weight: 700; margin: 0;">Students Assigned to You</h3>
      </div>
      {% if students %}
        <label for="student-select" style="font-weight:600;color:#2563eb;margin-bottom:0.7rem;display:block;">Search or select a student:</label>
        <select id="student-select" name="student" style="width:100%;padding:10px 14px;border-radius:8px;border:1.5px solid #2563eb;font-size:1.08rem;">
          <option value="">-- Select Student --</option>
          {% for student in students %}
            <option value="{{ student.matric_number }}" {% if selected_student == student.matric_number %}selected{% endif %}>{{ student.matric_number }} - {{ student.get_full_name|default:student.email }}</option>
          {% endfor %}
        </select>
      {% else %}
        <p style="color: #b45309; font-weight: 600;">No students assigned yet.</p>
      {% endif %}
    </div>

  <!-- Only one submissions/history container should exist. The below is the correct single container. -->
    <div class="table-container">
      <form method="get" id="table-filter-form">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.2rem; flex-wrap: wrap; gap: 1rem;">
          <h3 style="margin: 0;">Student Submissions</h3>
          <div style="display:flex;align-items:center;gap:0.7rem;">
            <button type="submit" class="btn" style="padding: 6px 16px; background: #2563eb; color: #fff;">Filter</button>
            {% if filter_date or status_filter %}
              <a href="?" class="btn" style="background: #e0e7ff; color: #2563eb; border: 1px solid #2563eb; margin-left: 6px;">Clear</a>
            {% endif %}
          </div>
        </div>
        <table class="supervisor-table">
        <thead>
          <tr>
            <th>Matric Number</th>
            <th>Student Name</th>
            <th>
              <div style="display:flex;align-items:center;gap:6px;">
                <span>Date</span>
                <input type="date" id="filter_date" name="filter_date" value="{{ filter_date|default:'' }}" style="padding:3px 7px;border-radius:5px;border:1px solid #2563eb;font-size:0.98rem;">
              </div>
            </th>
            <!-- Description column removed -->
            <th>File</th>
            <th>
              <div style="display:flex;align-items:center;gap:6px;">
                <span>Status</span>
                <select name="status" id="status_filter" style="padding:3px 7px;border-radius:5px;border:1px solid #2563eb;font-size:0.98rem;">
                  <option value="" {% if not status_filter %}selected{% endif %}>All</option>
                  <option value="approved" {% if status_filter == 'approved' %}selected{% endif %}>Approved</option>
                  <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Pending</option>
                </select>
              </div>
            </th>
            <!-- Action column removed -->
          </tr>
        </thead>
        <tbody>
        {% for submission in submissions %}
          <tr>
            <td>
              <a href="#" class="open-modal" data-id="{{ submission.id }}" style="color:#2563eb;text-decoration:underline;cursor:pointer;">{{ submission.matric_number }}</a>
              <!-- Modal Popup -->
              <div id="modal-{{ submission.id }}" class="modal" style="display:none;position:fixed;z-index:1000;left:0;top:0;width:100vw;height:100vh;background:rgba(30,41,59,0.18);overflow:auto;">
                <div style="background:#f8fafc;max-width:900px;width:96vw;margin:4% auto;padding:2.5rem 3rem 2.2rem 3rem;border-radius:20px;box-shadow:0 8px 32px rgba(30,41,59,0.13);position:relative;max-height:85vh;overflow-y:auto;">
                  <button class="close-modal" data-id="{{ submission.id }}" style="position:absolute;top:16px;right:22px;font-size:2rem;background:none;border:none;cursor:pointer;color:#2563eb;">&times;</button>
                  <h2 style="color:#2563eb;margin-bottom:1.2rem;font-family:'Orbitron',sans-serif;font-size:2rem;letter-spacing:1px;">Submission Details</h2>
                  <div style="margin-bottom:1.1rem;display:flex;gap:1.2rem;align-items:center;">
                    <span style="background:#e0e7ff;color:#2563eb;padding:6px 16px;border-radius:8px;font-weight:600;font-size:1.05rem;">Date: {{ submission.date|localtime|date:'Y-m-d H:i' }}</span>
                    <span style="background:#e0e7ff;color:#2563eb;padding:6px 16px;border-radius:8px;font-weight:600;font-size:1.05rem;">Matric: {{ submission.matric_number }}</span>
                  </div>
                  <div style="margin-bottom:1.1rem;">
                    <strong style="color:#1e293b;font-size:1.08rem;">Student Name:</strong>
                    <span style="color:#2563eb;font-weight:600;font-size:1.08rem;">{{ submission.student.get_full_name|default:submission.student.email }}</span>
                  </div>
                  <div style="margin-bottom:1.1rem;">
                    <strong style="color:#1e293b;font-size:1.08rem;">Description:</strong><br>
                    <span style="color:#334155;font-size:1.05rem;line-height:1.7;background:#e0e7ff;padding:10px 14px;border-radius:8px;display:block;margin-top:6px;white-space:pre-line;">{{ submission.text }}</span>
                  </div>
                  <div style="margin-bottom:1.1rem;">
                    <strong style="color:#1e293b;font-size:1.08rem;">File:</strong>
                    {% if submission.file %}
                      <a href="{{ submission.file.url }}" target="_blank" style="color:#2563eb;text-decoration:underline;font-weight:600;">View File</a>
                    {% else %}<span style="color:#b91c1c;">No file</span>{% endif %}
                  </div>
                  <div style="margin-bottom:1.1rem;">
                    <strong style="color:#1e293b;font-size:1.08rem;">Status:</strong>
                    {% if submission.approved %}
                      <span style="color:green;font-weight:600;">Approved</span>
                    {% else %}
                      <span style="color:orange;font-weight:600;">Pending</span>
                    {% endif %}
                  </div>
                  <div style="margin-bottom:1.1rem;">
                    <strong style="color:#1e293b;font-size:1.08rem;">Remark:</strong>
                    <span id="remark-text-{{ submission.id }}" {% if not submission.remark %}style="display:none;color:#2563eb;font-weight:600;"{% else %}style="color:#2563eb;font-weight:600;"{% endif %}>{{ submission.remark|default:'No remark yet.' }}</span>
                    {% if submission.remark %}
                    <button type="button" class="edit-remark-btn" data-id="{{ submission.id }}" style="margin-left:10px;padding:2px 10px;font-size:0.98rem;background:#e0e7ff;color:#2563eb;border-radius:6px;border:none;cursor:pointer;">Edit</button>
                    {% endif %}
                    <form id="remark-form-{{ submission.id }}" class="remark-edit-form" {% if submission.remark %}style="display:none;margin-top:10px;"{% else %}style="display:block;margin-top:10px;"{% endif %} onsubmit="return false;">
                      {% csrf_token %}
                      {# For debugging: show the CSRF token input #}
                      <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                      <textarea id="remark-input-{{ submission.id }}" rows="3" style="width:100%;margin-bottom:8px;padding:10px 12px;border-radius:8px;border:1px solid #2563eb;font-size:1.05rem;">{{ submission.remark|default_if_none:'' }}</textarea>
                      <div style="display:flex;gap:10px;">
                        <button type="button" class="save-remark-btn" data-id="{{ submission.id }}" style="background:#2563eb;color:#fff;padding:6px 18px;border-radius:6px;border:none;">Save</button>
                        <button type="button" class="cancel-remark-btn" data-id="{{ submission.id }}" style="background:#e0e7ff;color:#2563eb;padding:6px 18px;border-radius:6px;border:none;">Cancel</button>
                        <span id="remark-status-{{ submission.id }}" style="margin-left:10px;font-size:0.98rem;"></span>
                      </div>
                    </form>
                  </div>
                  {% if not submission.approved %}
                  <form method="post" action="" style="margin-top:1.2rem;">
                    {% csrf_token %}
                    <input type="hidden" name="approve_id" value="{{ submission.id }}">
                    <button type="submit" class="approve-btn" style="width:100%;margin-top:2px;">Approve</button>
                  </form>
                  {% endif %}
                </div>
              </div>
            </td>
            <td>{{ submission.student.get_full_name|default:submission.student.email }}</td>
            <td>{{ submission.date|localtime|date:'Y-m-d H:i' }}</td>
            <!-- Description cell removed, shown in modal only -->
            <td>
              {% if submission.file %}
                <a href="{{ submission.file.url }}" target="_blank">View File</a>
              {% else %}
                -
              {% endif %}
            </td>
            <td>
              {% if submission.approved %}
                <span style="color:green;">Approved</span>
              {% else %}
                <span style="color:orange;">Pending</span>
              {% endif %}
            </td>
            <!-- Action cell removed, actions now only in modal -->
          </tr>
<script>
// Modal popup logic and inline remark editing
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.open-modal').forEach(function(link) {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      var id = this.getAttribute('data-id');
      document.getElementById('modal-' + id).style.display = 'block';
    });
  });
  document.querySelectorAll('.close-modal').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var id = this.getAttribute('data-id');
      document.getElementById('modal-' + id).style.display = 'none';
    });
  });
  // Close modal on background click
  document.querySelectorAll('.modal').forEach(function(modal) {
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        modal.style.display = 'none';
      }
    });
  });

  // Inline remark edit logic
  // Use event delegation for edit-remark-btn so it works for dynamically added buttons
  document.body.addEventListener('click', function(e) {
    if (e.target.classList.contains('edit-remark-btn')) {
      var id = e.target.getAttribute('data-id');
      document.getElementById('remark-text-' + id).style.display = 'none';
      document.getElementById('remark-form-' + id).style.display = 'block';
      var textarea = document.getElementById('remark-input-' + id);
      if (textarea) textarea.focus();
    }
  });
  document.querySelectorAll('.cancel-remark-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var id = this.getAttribute('data-id');
      document.getElementById('remark-form-' + id).style.display = 'none';
      // Only show the remark text if a remark exists
      var remarkText = document.getElementById('remark-text-' + id);
      if (remarkText.textContent && remarkText.textContent.trim() !== 'No remark yet.') {
        remarkText.style.display = '';
      }
    });
  });
  document.querySelectorAll('.save-remark-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var id = this.getAttribute('data-id');
      var textarea = document.getElementById('remark-input-' + id);
      var status = document.getElementById('remark-status-' + id);
      var value = textarea.value;
      status.textContent = 'Saving...';
      // Get CSRF token from the form containing this button
      var form = document.getElementById('remark-form-' + id);
      var csrfInput = form.querySelector('input[name=csrfmiddlewaretoken]');
      var csrfToken = csrfInput ? csrfInput.value : (document.querySelector('input[name=csrfmiddlewaretoken]') ? document.querySelector('input[name=csrfmiddlewaretoken]').value : '');
      fetch('/supervisor/ajax/edit_remark/' + id + '/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': csrfToken
        },
        body: 'remark=' + encodeURIComponent(value)
      })
      .then(response => response.json())
      .then(data => {
        var remarkText = document.getElementById('remark-text-' + id);
        var editBtn = document.querySelector('.edit-remark-btn[data-id="' + id + '"]');
        var remarkForm = document.getElementById('remark-form-' + id);
        if (data.success) {
          remarkText.textContent = data.remark || 'No remark yet.';
          if (data.remark && data.remark.trim() !== '') {
            remarkText.style.display = '';
            remarkForm.style.display = 'none';
            if (!editBtn) {
              // Create and insert the edit button if it doesn't exist
              var btn = document.createElement('button');
              btn.type = 'button';
              btn.className = 'edit-remark-btn';
              btn.setAttribute('data-id', id);
              btn.style.marginLeft = '10px';
              btn.style.padding = '2px 10px';
              btn.style.fontSize = '0.98rem';
              btn.style.background = '#e0e7ff';
              btn.style.color = '#2563eb';
              btn.style.borderRadius = '6px';
              btn.style.border = 'none';
              btn.style.cursor = 'pointer';
              btn.textContent = 'Edit';
              btn.onclick = function() {
                remarkText.style.display = 'none';
                remarkForm.style.display = 'block';
                var textarea = document.getElementById('remark-input-' + id);
                if (textarea) textarea.focus();
              };
              remarkText.parentNode.insertBefore(btn, remarkText.nextSibling);
            }
          } else {
            remarkText.style.display = 'none';
            remarkForm.style.display = 'block';
            if (editBtn) editBtn.remove();
          }
          status.textContent = 'Saved!';
        } else {
          status.textContent = 'Error: ' + (data.error || 'Could not save.');
        }
      })
      .catch(() => {
        status.textContent = 'Error: Could not save.';
        // Debug log for troubleshooting
        console.error('AJAX error: Could not save remark. Check CSRF token and network.');
      });
    });
  });
});
</script>
        {% empty %}
          <tr><td colspan="7">No submissions yet.</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}
